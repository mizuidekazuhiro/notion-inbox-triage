name: Send Tasks Digest

on:
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch digest and send email
        env:
          WORKER_URL: ${{ secrets.WORKER_URL }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          MAIL_FROM_NAME: ${{ secrets.MAIL_FROM_NAME }}
        run: |
          node <<'NODE'
          const workerUrl = process.env.WORKER_URL?.replace(/\/$/, "");
          const mailFrom = process.env.MAIL_FROM;
          const mailToRaw = process.env.MAIL_TO;
          const mailFromName = process.env.MAIL_FROM_NAME || "Notion Inbox Bot";

          if (!workerUrl) {
            throw new Error("WORKER_URL is required");
          }
          if (!mailFrom || !mailToRaw) {
            throw new Error("MAIL_FROM and MAIL_TO are required");
          }

          const recipients = mailToRaw
            .split(",")
            .map((email) => email.trim())
            .filter(Boolean)
            .map((email) => ({ email }));

          if (recipients.length === 0) {
            throw new Error("MAIL_TO must contain at least one email");
          }

          const stripHtml = (html) =>
            html
              .replace(/<br\s*\/?>/gi, "\n")
              .replace(/<\/p>/gi, "\n\n")
              .replace(/<[^>]+>/g, "")
              .trim();

          const fetchDigest = async () => {
            const res = await fetch(`${workerUrl}/mail/digest`);
            if (!res.ok) {
              const text = await res.text();
              throw new Error(`Failed to fetch digest: ${res.status} ${text}`);
            }
            return res.json();
          };

          const sendMail = async (subject, body) => {
            const payload = {
              personalizations: [
                {
                  to: recipients
                }
              ],
              from: {
                email: mailFrom,
                name: mailFromName
              },
              subject,
              content: [
                {
                  type: "text/plain",
                  value: stripHtml(body)
                },
                {
                  type: "text/html",
                  value: body
                }
              ]
            };

            const res = await fetch("https://api.mailchannels.net/tx/v1/send", {
              method: "POST",
              headers: {
                "content-type": "application/json"
              },
              body: JSON.stringify(payload)
            });

            if (!res.ok) {
              const text = await res.text();
              throw new Error(`MailChannels send failed: ${res.status} ${text}`);
            }
          };

          (async () => {
            const digest = await fetchDigest();
            await sendMail(digest.subject, digest.body);
            console.log(`Sent digest: ${digest.subject}`);
          })().catch((error) => {
            console.error(error);
            process.exit(1);
          });
          NODE
